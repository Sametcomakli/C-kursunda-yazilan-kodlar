#define _CRT_SECURE_NO_WARNINGS

#include "date.h"
#include "nutility.h"
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#define     PRIVATE				static
#define     PUBLIC

#define     RANDOM_MAX_YEAR     2020
#define     RANDOM_MIN_YEAR     1950
#define		YEARBASE			1900
#define     isleap(y)           ((y) % 4 == 0 && ((y) % 100 != 0 || (y) % 400 == 0))
#define     mdays(y, m)         daytabs[isleap(y)][m]


PRIVATE const int daytabs[2][13] = {
	{0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31},
	{0, 31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31},
};

PRIVATE const char* const pmons[] = {
	"",
	"Ocak",
	"Subat",
	"Mart",
	"Nisan",
	"Mayis",
	"Haziran",
	"Temmuz",
	"Agustos",
	"Eylul",
	"Ekim",
	"Kasim",
	"Aralik"
};

PRIVATE const char* const pdays[] = {
"Pazar",
"Pazartesi",
"Sali",
"Carsamba",
"Persembe",
"Cuma",
"Cumartesi",
};

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PRIVATE Date* set(Date* p, int d, int m, int y);
PRIVATE int is_valid_date(int d, int m, int y);
PRIVATE int totaldays(const Date* p);
PRIVATE Date* to_date(Date*, int totaldays);

//PUBLIC FUNCTION DEFINITIONS

PUBLIC Date* set_date(Date* p, int day, int mon, int year)
{
	return set(p, day, mon, year);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_todays_date(Date* p)
{
	time_t timer;
	time(&timer);
	
	struct tm* tptr = localtime(&timer);
	return set(p, tptr->tm_mday, tptr->tm_mon + 1, tptr->tm_year + 1900);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_date_by_str(Date* p, const char* pstr)
{
	return set(p, atoi(pstr), atoi(pstr + 3), atoi(pstr + 6));
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_date_random(Date* p)
{
	int y = rand() % (RANDOM_MAX_YEAR - RANDOM_MIN_YEAR + 1) + RANDOM_MIN_YEAR;
	int m = rand() % 12 + 1;
	int d = rand() % mdays(y, m) + 1;

	return set(p, d, m, y);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_year(Date* p, int y)
{
	return set(p, get_month_day(p), get_month(p), y);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_month(Date* p, int m)
{
	return set(p, get_month_day(p), m, get_year(p));
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* set_month_day(Date* p, int mday)
{
	return set(p, mday, get_month(p), get_year(p));
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_year(const Date* p)
{
	return p->my;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_month(const Date* p)
{
	return p->mm;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_month_day(const Date* p)
{
	return p->md;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_week_day(const Date* p)
{
	return day_of_week(get_month_day(p), get_month(p), get_year(p));
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_year_day(const Date* p)
{
	int sum = get_month_day(p);
	int mon = get_month(p);
	int year = get_year(p);

	for (int i = 1; i < mon; ++i)
		sum += mdays(year, i);

	return sum;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC void print_date(const Date* p)
{
	printf("%02d %s %d %s\n", get_month_day(p), pmons[get_month(p)], get_year(p),
		pdays[get_week_day(p)]);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

//another alternative for print_date function
PUBLIC void print_date_(FILE *f, const Date* p)
{
	fprintf(f, "%02d %s %d %s\n", get_month_day(p), pmons[get_month(p)], get_year(p),
		pdays[get_week_day(p)]);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC Date* scan_date(Date* p)
{
	int d, m, y;

	scanf("%d%d%d", &d, &m, &y);
	return set(p, d, m, y);
}


//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PUBLIC int get_date_diff(const Date* p1, const Date* p2)
{
	return abs(totaldays(p1) - totaldays(p2));
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

int cmp_date(const Date* px, const Date* py)
{
	int yx = get_year(px);
	int yy = get_year(py);
	if (yx != yy)
		return yx - yy;

	int mx = get_month(px);
	int my = get_month(py);

	if (mx != my)
		return mx - my;

	return get_month_day(px) - get_month_day(py);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

Date* ndays_date(Date* pdest, const Date* source, int n)
{
	return to_date(pdest, totaldays(source) + n);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

// private function definitions

PRIVATE Date* set(Date* p, int d, int m, int y)
{
	if (!is_valid_date(d, m, y)) {
		fprintf(stderr, "gecersiz tarih olustu!!!\n");
		exit(EXIT_FAILURE);
	}

	p->md = d;
	p->mm = m;
	p->my = y;

	return p;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PRIVATE  int is_valid_date(int d, int m, int y)
{
	return y >= YEARBASE && m > 0 && m <= 12 && d > 0 && d <= mdays(y, m);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PRIVATE int totaldays(const Date* p)
{
	int sum = get_year_day(p);
	int y = get_year(p);

	for (int i = YEARBASE; i < y; ++i)
		sum += isleap(i) ? 366 : 365;

	return sum;
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

PRIVATE Date* to_date(Date*p, int totaldays)
{
	int y = YEARBASE;

	while (totaldays > (isleap(y) ? 366 : 365)) {
		totaldays -= (isleap(y) ? 366 : 365);
		++y;
	}

	int m = 1;

	while (totaldays > mdays(y, m)) {
		totaldays -= mdays(y, m);
		++m;
	}

	int d = totaldays;

	return set(p, d, m, y);
}

//----------------------------------------------------------------------------------------------------
//----------------------------------------------------------------------------------------------------

